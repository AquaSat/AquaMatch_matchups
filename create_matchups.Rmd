---
title: "AquaMatch WQP Matchups"
author: "ROSSyndicate"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 80
---

```{r file-setup}
library(tidyverse) 
library(data.table)
# FYI some conflicts with data.table, mostly {dplyr} and {lubridate} 
# functions, to use the tidyverse version of these functions you will 
# need to use the `package_name::function()` (eg: `dplyr::select()`) to
# access
library(sf)
library(arrow)
library(googledrive)

# Files sourced from Drive are available to any Google User, the console will walk through authentication steps.
drive_auth()
```

# Purpose

This markdown file walks through the process of creating matchups from the
AquaMatch harmonized data from the Water Quality Portal and the AquaMatch Landsat C2 SR data across the United States and its Territories.

## Bring in data

### *In situ* data
We access AquaMatch *in situ* data directly from the EDI Data Repository. We adapt helper scripts generated by EDI to read in the data - these are stored in the `src` folder of the matchup repository. Note that these scripts are based on specific versions of the published data products. If revised versions are published then the scripts may need to be updated in order to grab the newest data versions. The code chunk below defines which published parameters (Chlorophyll *a*, Dissolved Organic Carbon, Secchi Disk Depth, Total Suspended Solids, etc.) to download from EDI.

```{r download-edi}
# Where to put the data
edi_download_path <- "in/edi_data/"

# Check for download directory, make if it does not exist
if (!dir.exists(edi_download_path)) {
  dir.create(edi_download_path, recursive = TRUE)
}

# This code chunk will take a few minutes to run if not run previously

# Chla
# Citation: 
# Brousil, M.R., M.F. Meyer, K. Willi, B.G. Steele, J. De La Torre, and M.R. Ross. 2024. AquaMatch Chlorophyll a Data from Water Quality Portal: ~1970-2024 ver 2. Environmental Data Initiative. https://doi.org/10.6073/pasta/2f750544112e5408928dd9a61e6ace30 (Accessed 2025-09-17).
source(file = "src/retrieve_chla.R")

# DOC
# Brousil, M.R., M.F. Meyer, K. Willi, B.G. Steele, and M.R. Ross. 2024. AquaMatch Dissolved Organic Carbon Data from Water Quality Portal: ~1970-2024 ver 1. Environmental Data Initiative. https://doi.org/10.6073/pasta/31d271897f074da990a4f25108ff2a40 (Accessed 2025-09-17).
source(file = "src/retrieve_doc.R")

# SDD
# De La Torre, J., B.G. Steele, M.R. Brousil, M.F. Meyer, K. Willi, and M.R. Ross. 2025. AquaMatch Secchi Disk Depth Data from Water Quality Portal: ~1970-2024 ver 1. Environmental Data Initiative. https://doi.org/10.6073/pasta/542a305e8484ae5abc33881bd7761308 (Accessed 2025-09-17).
source(file = "src/retrieve_sdd.R")

# TSS
# Brousil, M.R., M.F. Meyer, K. Willi, B.G. Steele, J.R. Gardner, and M.R. Ross. 2025. AquaMatch Total Suspended Solids from Water Quality Portal ~1970-2025 ver 2. Environmental Data Initiative. https://doi.org/10.6073/pasta/6cde7f8613ef5e7e2bef3a19160e02ea (Accessed 2025-09-17).
source(file = "src/retrieve_tss.R")
```

### Remote sensing data
Next we download the siteSR data. This is currently done from Google Drive, but in the future this will change once the data are formally published.
```{r download-rs}
rs_download_path <- "in/siteSR_data/"

# Check for download directory, make if it does not exist
if (!dir.exists(rs_download_path)) {
  dir.create(rs_download_path, recursive = TRUE)
}

# At this time, the C2 data are sourced from Drive, will be updated once the pub is out
# This may take several minutes if the files have not yet been downloaded.
source("src/load_Landsat_C2_SRST.R")
```


## Making Matchups

There are many different ways and filters that can be applied to matchups. River
sites change more rapidly than lake sites (generally speaking), so matchup
windows (the time allowed between satellite acquisition and in situ
observation/measurement) should be shorter. We use data.table functions for
these applications because they are the most efficient for datasets of this
size.

The following function makes matchups based on the prescribed window. (Note: See
implementation of this for 5-day window in `code_ex/1_make_matches.R`, which
came from my scratch folder in the siteSR repo, not tracked in Git. That is from
an earlier version of the siteSR data, so there might need to be adjustments.)

```{r}
#' @param sat_fp: filepath to the satellite data
#' @param data: in situ data 
#' @param window: integer of number of days on either side of the insitu measuerment
make_matchups <- function(sat_fp, data, window) {
  data <- data %>% 
    mutate(harmonized_utc = force_tz(harmonized_utc, "UTC"),
           date = ymd(format(harmonized_utc, "%Y-%m-%d")))
  sat <- read_csv(sat_fp) %>% 
    filter(siteSR_id %in% unique(data$siteSR_id))
  
  # only grab id columns to make this a bit less computationally taxing
  sat_less <- sat %>% 
    select(sat_data_id, rowid, calc_date) 
  
  # coerce to data.table
  setDT(data)
  setDT(sat_less)
  setDT(sat)
  
  # overjoin using data.table syntax (cause this is biiiiiiig) and also filter in one step (also because of size)
  # todo: change this to data.table::foverlaps() instead of this type of data.table join
  matches <- sat_less[data, on = .(rowid), allow.cartesian = TRUE][abs(as.integer(difftime(date, calc_date, units = "days"))) <= window]
  
  # add the sat data back in
  left_join(matches, sat)
}

```

## Applying correction coefficients

Apply the correction coefficients from lakeSR here. They will also eventually be
in the data pub, but for now, grab from the lakeSR repo. One applicaiton for Roy
(MLE) and one application for Gardner-style (poly). Also flag input reflectance
beyond the input min/max values listed in the table. See implementation example
in <https://github.com/steeleb/regional-clarity-RS-model/> (not on main repo
yet) in the script `regional_clarity/3_make_models.R`. Note this example does
not flag refelctance beyond min/max of input, but should probably be included in
our data pub, there's an explanation as to why it's important for Gardner model
especially in the bookdown. I'm pretty sure I have code for that somewhere if
it's helpful.
